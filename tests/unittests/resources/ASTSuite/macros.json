{"type": "Begin", "children": [{"type": "Macro", "name": {"type": "Symbol", "name": "suffix-dup"}, "args": [{"type": "Symbol", "name": "sym"}, {"type": "Symbol", "name": "x"}], "body": {"type": "Begin", "children": [{"type": "MacroCondition", "condition": {"type": "FunctionCall", "name": {"type": "Symbol", "name": ">"}, "args": [{"type": "Symbol", "name": "x"}, {"type": "Number", "value": 1}]}, "then": {"type": "FunctionCall", "name": {"type": "Symbol", "name": "suffix-dup"}, "args": [{"type": "Symbol", "name": "sym"}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "-"}, "args": [{"type": "Symbol", "name": "x"}, {"type": "Number", "value": 1}]}]}, "else": {"type": "Symbol", "name": "nil"}}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "$symcat"}, "args": [{"type": "Symbol", "name": "sym"}, {"type": "Symbol", "name": "x"}]}]}}, {"type": "Macro", "name": {"type": "Symbol", "name": "partial"}, "args": [{"type": "Symbol", "name": "func"}, {"type": "Spread", "name": "defargs"}], "body": {"type": "Begin", "children": [{"type": "Macro", "name": {"type": "Symbol", "name": "bloc"}, "value": {"type": "FunctionCall", "name": {"type": "Symbol", "name": "suffix-dup"}, "args": [{"type": "Symbol", "name": "a"}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "-"}, "args": [{"type": "FunctionCall", "name": {"type": "Symbol", "name": "$argcount"}, "args": [{"type": "Symbol", "name": "func"}]}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "len"}, "args": [{"type": "Symbol", "name": "defargs"}]}]}]}}, {"type": "Fun", "args": [{"type": "Symbol", "name": "bloc"}], "body": {"type": "FunctionCall", "name": {"type": "Symbol", "name": "func"}, "args": [{"type": "Spread", "name": "defargs"}, {"type": "Symbol", "name": "bloc"}]}}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "$undef"}, "args": [{"type": "Symbol", "name": "bloc"}]}]}}, {"type": "Let", "name": {"type": "Symbol", "name": "test_func"}, "value": {"type": "Fun", "args": [{"type": "Symbol", "name": "a"}, {"type": "Symbol", "name": "b"}, {"type": "Symbol", "name": "c"}], "body": {"type": "FunctionCall", "name": {"type": "Symbol", "name": "*"}, "args": [{"type": "Symbol", "name": "a"}, {"type": "Symbol", "name": "b"}, {"type": "Symbol", "name": "c"}]}}}, {"type": "Let", "name": {"type": "Symbol", "name": "test_func1"}, "value": {"type": "FunctionCall", "name": {"type": "Symbol", "name": "partial"}, "args": [{"type": "Symbol", "name": "test_func"}, {"type": "Number", "value": 1}]}}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "print"}, "args": [{"type": "String", "value": "Generated partial functions for test_func (a b c) => (* a b c)"}]}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "print"}, "args": [{"type": "String", "value": "Expected arguments for test_func:  "}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "$argcount"}, "args": [{"type": "Symbol", "name": "test_func"}]}, {"type": "String", "value": ", expected "}, {"type": "Number", "value": 3}]}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "print"}, "args": [{"type": "String", "value": "Expected arguments for test_func1: "}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "$argcount"}, "args": [{"type": "Symbol", "name": "test_func1"}]}, {"type": "String", "value": ", expected "}, {"type": "Number", "value": 2}]}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "print"}, "args": [{"type": "String", "value": "Calling them: "}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "test_func"}, "args": [{"type": "Number", "value": 1}, {"type": "Number", "value": 2}, {"type": "Number", "value": 3}]}, {"type": "String", "value": " "}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "test_func1"}, "args": [{"type": "Number", "value": 2}, {"type": "Number", "value": 3}]}]}, {"type": "Macro", "name": {"type": "Symbol", "name": "foo"}, "args": [{"type": "Symbol", "name": "a"}, {"type": "Symbol", "name": "b"}], "body": {"type": "FunctionCall", "name": {"type": "Symbol", "name": "+"}, "args": [{"type": "Symbol", "name": "a"}, {"type": "Symbol", "name": "b"}]}}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "print"}, "args": [{"type": "String", "value": "Using macro foo (a b) => (+ a b): "}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "foo"}, "args": [{"type": "Number", "value": 1}, {"type": "Number", "value": 2}]}]}, {"type": "Macro", "name": {"type": "Symbol", "name": "var"}, "value": {"type": "Number", "value": 12}}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "print"}, "args": [{"type": "String", "value": "Using macro constant var=12: "}, {"type": "Symbol", "name": "var"}]}, {"type": "MacroCondition", "condition": {"type": "FunctionCall", "name": {"type": "Symbol", "name": "="}, "args": [{"type": "Symbol", "name": "var"}, {"type": "Number", "value": 12}]}, "then": {"type": "FunctionCall", "name": {"type": "Symbol", "name": "print"}, "args": [{"type": "String", "value": "This was executed in a if macro, testing var == 12"}]}, "else": {"type": "FunctionCall", "name": {"type": "Symbol", "name": "print"}, "args": [{"type": "String", "value": "You shouldn't see this"}]}}, {"type": "MacroCondition", "condition": {"type": "FunctionCall", "name": {"type": "Symbol", "name": "and"}, "args": [{"type": "Symbol", "name": "true"}, {"type": "Symbol", "name": "true"}]}, "then": {"type": "FunctionCall", "name": {"type": "Symbol", "name": "print"}, "args": [{"type": "String", "value": "This was executed in a if macro, testing (and true true)"}]}, "else": {"type": "FunctionCall", "name": {"type": "Symbol", "name": "print"}, "args": [{"type": "String", "value": "You shouldn't see this (bis)"}]}}, {"type": "Macro", "name": {"type": "Symbol", "name": "defun"}, "args": [{"type": "Symbol", "name": "name"}, {"type": "Symbol", "name": "args"}, {"type": "Symbol", "name": "body"}], "body": {"type": "Let", "name": {"type": "Symbol", "name": "name"}, "value": {"type": "Fun", "args": {"type": "Symbol", "name": "args"}, "body": {"type": "Symbol", "name": "body"}}}}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "defun"}, "args": [{"type": "Symbol", "name": "a_func"}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "a"}, "args": [{"type": "Symbol", "name": "b"}]}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "+"}, "args": [{"type": "Symbol", "name": "a"}, {"type": "Symbol", "name": "b"}]}]}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "print"}, "args": [{"type": "String", "value": "Generated a function with a macro, a_func (a b) => (+ a b)"}]}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "print"}, "args": [{"type": "String", "value": "Calling (a_func 1 2): "}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "a_func"}, "args": [{"type": "Number", "value": 1}, {"type": "Number", "value": 2}]}]}, {"type": "Macro", "name": {"type": "Symbol", "name": "one"}, "args": [{"type": "Spread", "name": "args"}], "body": {"type": "FunctionCall", "name": {"type": "Symbol", "name": "print"}, "args": [{"type": "String", "value": "Macro 'one', returns the 2nd argument given in "}, {"type": "Symbol", "name": "args"}, {"type": "String", "value": " => "}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "@"}, "args": [{"type": "Symbol", "name": "args"}, {"type": "Number", "value": 1}]}]}}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "one"}, "args": [{"type": "Number", "value": 1}, {"type": "Number", "value": 2}]}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "one"}, "args": [{"type": "Number", "value": 1}, {"type": "Number", "value": 3}, {"type": "Number", "value": 4}]}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "one"}, "args": [{"type": "Number", "value": 1}, {"type": "Number", "value": 5}, {"type": "Number", "value": 6}, {"type": "Number", "value": 7}, {"type": "Number", "value": 8}]}, {"type": "Macro", "name": {"type": "Symbol", "name": "last"}, "args": [{"type": "Spread", "name": "args"}], "body": {"type": "FunctionCall", "name": {"type": "Symbol", "name": "print"}, "args": [{"type": "String", "value": "Macro 'last', returns the last argument given in "}, {"type": "Symbol", "name": "args"}, {"type": "String", "value": " => "}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "@"}, "args": [{"type": "Symbol", "name": "args"}, {"type": "Number", "value": -1}]}]}}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "last"}, "args": [{"type": "Number", "value": 1}, {"type": "Number", "value": 2}]}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "last"}, "args": [{"type": "Number", "value": 1}, {"type": "Number", "value": 3}, {"type": "Number", "value": 4}]}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "last"}, "args": [{"type": "Number", "value": 1}, {"type": "Number", "value": 5}, {"type": "Number", "value": 6}, {"type": "Number", "value": 7}, {"type": "Number", "value": 8}]}, {"type": "Begin", "children": [{"type": "FunctionCall", "name": {"type": "Symbol", "name": "print"}, "args": [{"type": "String", "value": "Testing macros in scopes and macro shadowing"}]}, {"type": "Macro", "name": {"type": "Symbol", "name": "test"}, "value": {"type": "FunctionCall", "name": {"type": "Symbol", "name": "+"}, "args": [{"type": "Number", "value": 1}, {"type": "Number", "value": 2}, {"type": "Number", "value": 3}]}}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "print"}, "args": [{"type": "String", "value": "(global) Reading macro 'test', expected 6, "}, {"type": "Symbol", "name": "test"}]}, [{"type": "Fun", "args": [], "body": {"type": "Begin", "children": [{"type": "Macro", "name": {"type": "Symbol", "name": "test"}, "value": {"type": "FunctionCall", "name": {"type": "Symbol", "name": "-"}, "args": [{"type": "Number", "value": 1}, {"type": "Number", "value": 2}, {"type": "Number", "value": 3}]}}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "print"}, "args": [{"type": "String", "value": "(sub scope) Reading macro 'test', expected -4, "}, {"type": "Symbol", "name": "test"}]}]}}], {"type": "FunctionCall", "name": {"type": "Symbol", "name": "print"}, "args": [{"type": "String", "value": "(global) Reading macro 'test', expected 6, "}, {"type": "Symbol", "name": "test"}]}, {"type": "Begin", "children": [{"type": "Macro", "name": {"type": "Symbol", "name": "test"}, "value": {"type": "Number", "value": 555}}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "print"}, "args": [{"type": "String", "value": "(subscope) Reading macro 'test', expected 555, "}, {"type": "Symbol", "name": "test"}]}, {"type": "Macro", "name": {"type": "Symbol", "name": "undef"}, "value": {"type": "Symbol", "name": "test"}}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "print"}, "args": [{"type": "String", "value": "(subscope, undef test) Reading macro 'test', expected 6, "}, {"type": "Symbol", "name": "test"}]}, {"type": "Macro", "name": {"type": "Symbol", "name": "undef"}, "value": {"type": "Symbol", "name": "a"}}]}]}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "print"}, "args": [{"type": "String", "value": "Demonstrating a threading macro"}]}, {"type": "Macro", "name": {"type": "Symbol", "name": "->"}, "args": [{"type": "Symbol", "name": "arg"}, {"type": "Symbol", "name": "fn1"}, {"type": "Spread", "name": "fn"}], "body": {"type": "Begin", "children": [{"type": "MacroCondition", "condition": {"type": "FunctionCall", "name": {"type": "Symbol", "name": ">"}, "args": [{"type": "FunctionCall", "name": {"type": "Symbol", "name": "len"}, "args": [{"type": "Symbol", "name": "fn"}]}, {"type": "Number", "value": 0}]}, "then": {"type": "FunctionCall", "name": {"type": "Symbol", "name": "->"}, "args": [{"type": "FunctionCall", "name": {"type": "Symbol", "name": "fn1"}, "args": [{"type": "Symbol", "name": "arg"}]}, {"type": "Spread", "name": "fn"}]}, "else": {"type": "FunctionCall", "name": {"type": "Symbol", "name": "fn1"}, "args": [{"type": "Symbol", "name": "arg"}]}}]}}, {"type": "Let", "name": {"type": "Symbol", "name": "filename"}, "value": {"type": "String", "value": "hello.json"}}, {"type": "Let", "name": {"type": "Symbol", "name": "f1"}, "value": {"type": "Fun", "args": [{"type": "Symbol", "name": "data"}], "body": {"type": "Begin", "children": [{"type": "FunctionCall", "name": {"type": "Symbol", "name": "print"}, "args": [{"type": "String", "value": ">>f1 "}, {"type": "Symbol", "name": "data"}]}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "+"}, "args": [{"type": "Symbol", "name": "data"}, {"type": "String", "value": "-f1"}]}]}}}, {"type": "Let", "name": {"type": "Symbol", "name": "f2"}, "value": {"type": "Fun", "args": [{"type": "Symbol", "name": "data"}], "body": {"type": "Begin", "children": [{"type": "FunctionCall", "name": {"type": "Symbol", "name": "print"}, "args": [{"type": "String", "value": ">>f2 "}, {"type": "Symbol", "name": "data"}]}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "+"}, "args": [{"type": "Symbol", "name": "data"}, {"type": "String", "value": "-f2"}]}]}}}, {"type": "Let", "name": {"type": "Symbol", "name": "f3"}, "value": {"type": "Fun", "args": [{"type": "Symbol", "name": "data"}], "body": {"type": "Begin", "children": [{"type": "FunctionCall", "name": {"type": "Symbol", "name": "print"}, "args": [{"type": "String", "value": ">>f3 "}, {"type": "Symbol", "name": "data"}]}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "+"}, "args": [{"type": "Symbol", "name": "data"}, {"type": "String", "value": "-f3"}]}]}}}, {"type": "Let", "name": {"type": "Symbol", "name": "f4"}, "value": {"type": "Fun", "args": [{"type": "Symbol", "name": "data"}], "body": {"type": "Begin", "children": [{"type": "FunctionCall", "name": {"type": "Symbol", "name": "print"}, "args": [{"type": "String", "value": ">>f4 "}, {"type": "Symbol", "name": "data"}]}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "+"}, "args": [{"type": "Symbol", "name": "data"}, {"type": "String", "value": "-f4"}]}]}}}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "print"}, "args": [{"type": "String", "value": "We expected calls to go like this: f1, f2, f3, f4"}]}, {"type": "FunctionCall", "name": {"type": "Symbol", "name": "print"}, "args": [{"type": "FunctionCall", "name": {"type": "Symbol", "name": "->"}, "args": [{"type": "Symbol", "name": "filename"}, {"type": "Symbol", "name": "f1"}, {"type": "Symbol", "name": "f2"}, {"type": "Symbol", "name": "f3"}, {"type": "Symbol", "name": "f4"}]}]}]}